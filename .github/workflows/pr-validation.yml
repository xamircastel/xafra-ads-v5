# ğŸ§ª CI/CD Pipeline - PULL REQUEST VALIDATION
# ============================================
# Trigger: Pull Request to any branch
# Purpose: Code quality, tests, and build validation
# No deployment - only validation

name: ğŸ§ª PR Validation

on:
  pull_request:
    branches: [ master, develop ]

env:
  NODE_VERSION: '20'

jobs:
  # ========================================
  # JOB 1: CODE QUALITY CHECKS
  # ========================================
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: npm ci
      
    - name: ğŸ” Check for TypeScript errors
      run: npx tsc --noEmit
      
    - name: ğŸ¨ Check code formatting (if prettier configured)
      run: |
        if [ -f ".prettierrc" ] || [ -f "prettier.config.js" ]; then
          npx prettier --check "**/*.{ts,js,json,md}"
        else
          echo "âš ï¸ Prettier not configured, skipping format check"
        fi
      continue-on-error: true
      
    - name: ğŸ” Lint code (if ESLint configured)
      run: |
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
          npx eslint "**/*.{ts,js}"
        else
          echo "âš ï¸ ESLint not configured, skipping lint check"
        fi
      continue-on-error: true

  # ========================================
  # JOB 2: BUILD VALIDATION
  # ========================================
  build-validation:
    name: ğŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ Install root dependencies
      run: npm ci
      
    - name: ğŸ”§ Generate Prisma Client
      run: |
        cd packages/database
        npx prisma generate
        cd ../..
        
    - name: ğŸ—ï¸ Build all services
      run: |
        services=("core-service" "auth-service" "campaign-service" "tracking-service" "postback-service")
        
        for service in "${services[@]}"; do
          if [ -d "services/$service" ]; then
            echo "ğŸ—ï¸ Building $service..."
            cd "services/$service"
            
            # Install service dependencies
            if [ -f "package.json" ]; then
              npm ci
              
              # Build the service
              if npm run build; then
                echo "âœ… $service built successfully"
              else
                echo "âŒ $service build failed"
                exit 1
              fi
            else
              echo "âš ï¸ No package.json found in $service"
            fi
            
            cd ../..
          else
            echo "âš ï¸ Service directory not found: $service"
          fi
        done
        
    - name: ğŸ” Validate Dockerfile syntax
      run: |
        dockerfiles=("deployment/Dockerfile.core-service" "deployment/Dockerfile.auth-service" "deployment/Dockerfile.campaign-service" "deployment/Dockerfile.tracking-service" "deployment/Dockerfile.postback-service")
        
        for dockerfile in "${dockerfiles[@]}"; do
          if [ -f "$dockerfile" ]; then
            echo "ğŸ” Validating $dockerfile..."
            # Basic syntax check
            docker run --rm -i hadolint/hadolint < "$dockerfile" || echo "âš ï¸ Dockerfile linting issues found in $dockerfile"
          else
            echo "âš ï¸ Dockerfile not found: $dockerfile"
          fi
        done

  # ========================================
  # JOB 3: SECURITY SCAN
  # ========================================
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ›¡ï¸ Run npm audit
      run: |
        npm audit --audit-level high
      continue-on-error: true
      
    - name: ğŸ” Check for secrets in code
      run: |
        # Simple check for common secret patterns
        if grep -r -E "(password|secret|key|token).*=.*['\"][^'\"]{10,}" --exclude-dir=node_modules --exclude-dir=.git .; then
          echo "âš ï¸ Potential secrets found in code. Please review."
        else
          echo "âœ… No obvious secrets found in code"
        fi
      continue-on-error: true

  # ========================================
  # JOB 4: PR SUMMARY
  # ========================================
  pr-summary:
    name: ğŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [code-quality, build-validation, security-scan]
    if: always()
    
    steps:
    - name: ğŸ“‹ Generate PR summary
      run: |
        echo "## ğŸ“‹ Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.code-quality.result }}" == "success" ]; then
          echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.build-validation.result }}" == "success" ]; then
          echo "âœ… **Build Validation**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Build Validation**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "âœ… **Security Scan**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Security Scan**: Issues found (review required)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸš€ **Ready for merge**: All checks completed" >> $GITHUB_STEP_SUMMARY