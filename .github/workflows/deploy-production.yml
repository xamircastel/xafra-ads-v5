# ğŸ­ CI/CD Pipeline - PRODUCTION DEPLOYMENT
# =========================================
# Trigger: Push to 'master' branch OR manual dispatch
# Target: Production environment (xafra-ads.com)
# Purpose: Production deployment with safety checks

name: ğŸ­ Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # Manual trigger
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deployment)'
        required: false
        default: 'false'
        type: boolean

env:
  PROJECT_ID: xafra-ads
  REGION: us-central1
  GAR_LOCATION: us-central1-docker.pkg.dev/xafra-ads

jobs:
  # ========================================
  # JOB 1: SAFETY CHECKS
  # ========================================
  safety-checks:
    name: ğŸ›¡ï¸ Safety Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Verify production files
      run: |
        required_files=(
          "cloudbuild-core-prod.yaml"
          "cloudbuild-auth-prod.yaml" 
          "cloudbuild-campaign-prod.yaml"
          "cloudbuild-tracking-prod.yaml"
          "cloudbuild-postback-prod.yaml"
          "cloudbuild-gateway-prod.yaml"
          "environments/production/.env.production"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          else
            echo "âœ… Found: $file"
          fi
        done
        
    - name: ğŸ“¦ Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ§ª Run production tests (unless skipped)
      if: github.event.inputs.skip_tests != 'true'
      run: |
        npm ci
        cd packages/database
        npx prisma generate
        cd ../..
        
        # Build and test all services
        services=("core-service" "auth-service" "campaign-service" "tracking-service" "postback-service")
        for service in "${services[@]}"; do
          if [ -d "services/$service" ]; then
            echo "ğŸ—ï¸ Building $service for production..."
            cd "services/$service"
            npm ci
            npm run build
            cd ../..
          fi
        done

  # ========================================
  # JOB 2: DEPLOY TO PRODUCTION
  # ========================================
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: safety-checks
    environment: production  # GitHub environment protection
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/697203931362/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
        service_account: 'github-actions-xafra@xafra-ads.iam.gserviceaccount.com'
        
    - name: âš™ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: ğŸ”§ Configure Docker for GAR
      run: gcloud auth configure-docker us-central1-docker.pkg.dev
      
    - name: ğŸ—ï¸ Deploy Core Service PROD
      run: |
        echo "ğŸ—ï¸ Deploying Core Service to Production..."
        gcloud builds submit --config=cloudbuild-core-prod.yaml
        
    - name: ğŸ” Deploy Auth Service PROD
      run: |
        echo "ğŸ” Deploying Auth Service to Production..."
        gcloud builds submit --config=cloudbuild-auth-prod.yaml
        
    - name: ğŸ“Š Deploy Campaign Service PROD
      run: |
        echo "ğŸ“Š Deploying Campaign Service to Production..."
        gcloud builds submit --config=cloudbuild-campaign-prod.yaml
        
    - name: ğŸ“ˆ Deploy Tracking Service PROD
      run: |
        echo "ğŸ“ˆ Deploying Tracking Service to Production..."
        gcloud builds submit --config=cloudbuild-tracking-prod.yaml
        
    - name: ğŸ“¤ Deploy Postback Service PROD
      run: |
        echo "ğŸ“¤ Deploying Postback Service to Production..."
        gcloud builds submit --config=cloudbuild-postback-prod.yaml
        
    - name: ğŸŒ Deploy Gateway PROD
      run: |
        echo "ğŸŒ Deploying Gateway to Production..."
        gcloud builds submit --config=cloudbuild-gateway-prod.yaml

  # ========================================
  # JOB 3: PRODUCTION HEALTH CHECKS
  # ========================================
  production-health-check:
    name: ğŸ” Production Health Check
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:   
    - name: â±ï¸ Wait for production services to start
      run: sleep 120  # More time for production
      
    - name: ğŸ” Check Core Service PROD
      run: |
        curl -f https://core-service-prod-697203931362.us-central1.run.app/health || exit 1
        echo "âœ… Core Service PROD: Healthy"
        
    - name: ğŸ” Check Auth Service PROD
      run: |
        curl -f https://auth-service-prod-697203931362.us-central1.run.app/health || exit 1
        echo "âœ… Auth Service PROD: Healthy"
        
    - name: ğŸ” Check Campaign Service PROD
      run: |
        curl -f https://campaign-service-prod-697203931362.us-central1.run.app/health || exit 1
        echo "âœ… Campaign Service PROD: Healthy"
        
    - name: ğŸ” Check Tracking Service PROD
      run: |
        curl -f https://tracking-service-prod-697203931362.us-central1.run.app/health || exit 1
        echo "âœ… Tracking Service PROD: Healthy"
        
    - name: ğŸ” Check Postback Service PROD
      run: |
        curl -f https://postback-service-prod-697203931362.us-central1.run.app/health || exit 1
        echo "âœ… Postback Service PROD: Healthy"
        
    - name: ğŸ” Check Gateway PROD
      run: |
        curl -f https://gateway-prod-697203931362.us-central1.run.app/gateway/health || exit 1
        echo "âœ… Gateway PROD: Healthy"
        
    - name: ğŸ‰ Production deployment successful
      run: |
        echo "ğŸ‰ ALL PRODUCTION SERVICES ARE HEALTHY!"
        echo "ğŸŒ Xafra-ads v5 is now live in production!"
        
  # ========================================
  # JOB 4: ROLLBACK ON FAILURE
  # ========================================
  rollback-on-failure:
    name: ğŸ”„ Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-production, production-health-check]
    if: failure()
    
    steps:
    - name: ğŸš¨ Production deployment failed
      run: |
        echo "ğŸš¨ PRODUCTION DEPLOYMENT FAILED!"
        echo "ğŸ”„ Consider manual rollback if needed"
        echo "ğŸ“ Check logs and contact DevOps team"